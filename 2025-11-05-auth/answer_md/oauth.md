# OAuth 2.0

OAuth 2.0 は、リソース所有者（ユーザー）に代わってクライアント（アプリ）がリソースサーバにアクセスするための**認可**を与える仕組みを定めたプロトコルです。

## OAuth 2.0の4つの主要な要素

- **クライアント**:
    - 保護されたリソースへのアクセスを要求するアプリケーション。Webアプリケーションの場合、フロントエンド(公開クライアント)またはバックエンド(機密クライアント)が該当する。
    - ユーザー(リソースオーナー)を`{認可サーバ}`へリダイレクトさせることで認可を求め、払い出された`{認可コード}`を使って`{アクセストークン}`の発行をリクエストする。発行された`{アクセストークン}`を用いてリソースサーバ内のリソース取得を行う。

- **認可サーバ**:
    - アクセストークンを発行するサーバ
    - クライアントからの認可リクエストを受け、`{リソースオーナー}`の認証と同意を得た上で、`{クライアント}`に対して`{アクセストークン}`を発行する。

- **リソースオーナー**:
    - リソースの所有者であり、一般的にはエンドユーザーを指す。
    - `{クライアント}`に対して、自身のリソースへのアクセス権限を与える(または拒否する)役割を担う。

- **リソースサーバ**:
    - 保護されたリソースをホストするサーバ
    - クライアントから提示された`{アクセストークン}`を検証し、正当であればリソースへのアクセスを許可する。

## OAuth 2.0の認可フロー

1. **認可リクエスト**:
    - クライアントは`{リソースオーナー}`を`{認可サーバ}`の認可エンドポイントへリダイレクトさせる。
    - リクエスト送信時、どのようなレスポンスか(`{response_type}`), どのクライアントからの要求化(`{client_id}`), 認可コード払い出し後にどこにリダイレクトさせるか(`{redirect_uri}`), どのような権限を要求するか(`{scope}`)などのパラメータを`{QueryString}`に付与する。
    - **具体的なリダイレクト処理**:
        - クライアントは、ユーザーのブラウザに対して、認可サーバの認可エンドポイントへのリダイレクトを指示するHTTPレスポンス（通常はHTTP 302 Foundステータスコードと`{Location}`ヘッダ）を返します。
        - ユーザーのブラウザがそのHTTPレスポンスを受け取り、`{Location}`ヘッダに指定された`{認可サーバ}`のURLへ自動的にアクセスします。
        - この時、クライアントアプリケーションのバックエンドが直接認可サーバにリクエストを送信するわけではなく、**ユーザーのブラウザを介して**認可サーバへリクエストが送られます。

2. **リソースオーナーの認証と同意**:
    - `{認可サーバ}`は`{リソースオーナー}`に対して認証(ログイン)を要求し、クライアントに要求された権限(スコープ)へのアクセスを許可するかどうかの同意を求めます。

3. **認可コードの払い出し**:
    - リソースオーナーが同意すると、認可サーバはリソースオーナーをクライアントの`{redirect_uri}`にリダイレクトさせます。
    - リダイレクト時、`{QueryString}`に一時的な`{認可コード}`を付与します。

4. **アクセストークンのリクエスト**:
    - クライアントは受け取った`{認可コード}`を使い、自身の`{クライアントID}`と`{クライアントシークレット}`と共に、認可サーバのトークンエンドポイントにアクセストークンの発行リクエストを送信します。

5. **アクセストークンの発行**:
    - `{認可サーバ}`は認可コードを検証し、問題がなければクライアントに`{アクセストークン}`と、場合によっては`{リフレッシュトークン}`を発行します。

6. **リソースへのアクセス**:
    - クライアントは取得した`{アクセストークン}`をヘッダに含めて、リソースサーバに保護されたリソースを要求します。

```mermaid
sequenceDiagram
    participant RO as リソースオーナー
    participant C as クライアント
    participant AS as 認可サーバ
    participant RS as リソースサーバ

    RO->>C: 1. アプリケーションを利用開始
    C->>RO: 2. 認可リクエスト (認可サーバへリダイレクト)
    RO->>AS: 3. 認可リクエスト
    AS->>RO: 4. ログイン & 同意画面
    RO->>AS: 5. ログイン & 同意
    AS->>RO: 6. 認可コードを付与してリダイレクト
    RO->>C: 7. リダイレクトにより認可コードを渡す

    C->>AS: 8. 認可コード、クライアントIDとクライアントシークレットを送信
    AS->>C: 9. アクセストークンを発行

    C->>RS: 10. アクセストークンを提示してリソースを要求
    RS->>C: 11. リソースを返却
```

# OAuth 2.0

## OAuth 2.0の4つの主要な要素

- **クライアント**:
    - クライアントアプリケーション
    - アプリケーションのロジックに従い、認可サーバへアクセストークンの発行をリクエストし、発行されたアクセストークンを用いてリソースサーバ内のリソース取得を行う。

- **認可サーバ**:
    - アクセストークンを発行するサーバ
    - クライアントからのアクセストークン発行リクエストをトリガーとし、リソースオーナーに対してクライアントアプリがリソースへアクセスする権限を与えるかを聞く。権限を与える場合、クライアントに対してアクセストークンを発行する。

- **リソースオーナー**:
    - リソースの所有者(基本的にはユーザー)
    - クライアントに対して、自身のリソースへのアクセスを許可する権限を与える。

- **リソースサーバ**:
    - 保護されたリソースをホストするサーバ
    - クライアントから提示されたアクセストークンを検証し、正当であればリソースへのアクセスを許可する。(例: ユーザーのプロフィール画像を保持するAPIサーバ)

## OAuth 2.0の認可フロー

1. **認可リクエスト**:
    - クライアントがリソースオーナーを認可サーバの特定のエンドポイントにリダイレクトさせる。
    - リクエスト送信時、`response_type=code`, `client_id`, `redirect_uri`, `scope`などのパラメータをQueryStringに付与する。

2. **リソースオーナーの同意**:
    - リソースオーナーは認可サーバ上で認証(ログイン)し、クライアントに要求された権限(スコープ)を与えることに同意する。

3. **認可コードの払い出し**:
    - 認可サーバは、リソースオーナーをクライアントの`redirect_uri`にリダイレクトさせます。
    - リダイレクト時、QueryStringに認可コードを付与します。

4. **アクセストークンのリクエスト**:
    - クライアントは受け取った認可コードを使い、認可サーバのトークン発行用エンドポイントにリクエストを送信します。

5. **アクセストークンの発行**:
    - 認可サーバは認可コードを検証し、問題がなければクライアントにアクセストークンと、場合によってはリフレッシュトークンを発行します。

6. **リソースへのアクセス**:
    - クライアントは取得したアクセストークンを使って、リソースサーバに保護されたリソースを要求します。

```mermaid
sequenceDiagram
    participant RO as リソースオーナー
    participant C as クライアント
    participant AS as 認可サーバ
    participant RS as リソースサーバ

    RO->>C: 1. アプリケーションを利用開始
    C->>RO: 2. 認可リクエスト (認可サーバへリダイレクト)
    RO->>AS: 3. 認可リクエスト
    AS->>RO: 4. ログイン & 同意を要求
    RO->>AS: 5. ログイン & 同意
    AS->>RO: 6. 認可コードを付与してリダイレクト
    RO->>C: 7. 認可コードを渡す (Redirect)

    C->>AS: 8. 認可コード、Secret情報等を送信
    AS->>C: 9. アクセストークンを発行

    C->>RS: 10. アクセストークンを提示してリソースを要求
    RS->>C: 11. リソースを返却
```
